#!/usr/bin/env python
from os import environ
from os.path import join, basename
from glob import iglob
from pbs import queue
import re
from astropy.io import fits
queue = queue()
queue.verbose = True
nodes = 12
walltime = '336:00:00'

try: uufscell = environ['UUFSCELL']
except: uufscell = None
if 'kingspeak' in uufscell:
    alloc = 'sdss-kp'
    ppn=16
elif 'ember' in uufscell:
    alloc = 'bolton-em'
    ppn=12
else:
    alloc = None
    ppn=None

try: topdir = environ['BOSS_SPECTRO_REDUX']
except: topdir = None
try: run2d = environ['RUN2D']
except: run2d = None
platedir = join(topdir,run2d,'*','spPlate-*.fits') if topdir and run2d else None

if platedir:
    queue.create(label='zfind_dr10_cmass',alloc=alloc,nodes=nodes,ppn=ppn,walltime=walltime)
    for path in iglob(platedir):
        spfile = basename(path)
        m = re.search( 'spPlate-(\d{4})-(\d{5}).fits', spfile )
        plate = m.group(1)
        mjd = m.group(2)
        hdu = fits.open(path)
        for ind,flag in enumerate(hdu[5].data.BOSS_TARGET1):
            if flag & 2: 
                queue.append( "zfind -p %i -m %i -f %i" % (plate, mjds, ind) )
    queue.commit(hard=True,submit=True)